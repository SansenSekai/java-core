# –ú–æ–¥—É–ª—å 26: –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è

> **–£—Ä–æ–≤–µ–Ω—å**: ‚≠ê‚≠ê‚≠ê –°—Ä–µ–¥–Ω–∏–π+  
> **–í—Ä–µ–º—è**: 4-5 —á–∞—Å–æ–≤

## üìã –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ

### –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è?

**–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è** ‚Äî –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–π—Ç–æ–≤ –¥–ª—è:
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ –¥–∏—Å–∫
- –ü–µ—Ä–µ–¥–∞—á–∏ –ø–æ —Å–µ—Ç–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –ì–ª—É–±–æ–∫–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è** ‚Äî –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –±–∞–π—Ç–æ–≤.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     serialize      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     deserialize     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Object  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ   bytes[]   ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ  Object  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Serializable

–ú–∞—Ä–∫–µ—Ä–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–±–µ–∑ –º–µ—Ç–æ–¥–æ–≤), –∫–æ—Ç–æ—Ä—ã–π —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç JVM: "—ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –º–æ–∂–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å".

```java
public class Person implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private String name;
    private int age;
    private transient String password; // –ù–ï —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è!
}
```

### serialVersionUID

**–ó–∞—á–µ–º –Ω—É–∂–µ–Ω?** –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –≤–µ—Ä—Å–∏–π –ø—Ä–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

```java
private static final long serialVersionUID = 1L;
```

- –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–ª–∞—Å—Å–∞
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è) ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π UID –∏–∑–º–µ–Ω–∏—Ç—Å—è
- –ü—Ä–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî `InvalidClassException`

**–°–æ–≤–µ—Ç**: –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π serialVersionUID —è–≤–Ω–æ!

### –ß—Ç–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è?

| –°–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è | –ù–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è |
|---------------|------------------|
| –û–±—ã—á–Ω—ã–µ –ø–æ–ª—è | `transient` –ø–æ–ª—è |
| –û–±—ä–µ–∫—Ç—ã (–µ—Å–ª–∏ Serializable) | `static` –ø–æ–ª—è |
| –ü—Ä–∏–º–∏—Ç–∏–≤—ã | –ü–æ–ª—è –±–µ–∑ Serializable —Ç–∏–ø–∞ |

### transient

–ü–æ–º–µ—Ç—å `transient` –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ:
- –°–æ–¥–µ—Ä–∂–∞—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø–∞—Ä–æ–ª–∏)
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å (–∫—ç—à–∏)
- –°–æ–¥–µ—Ä–∂–∞—Ç –Ω–µ-—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–µ –æ–±—ä–µ–∫—Ç—ã

```java
private transient Connection dbConnection;
private transient String cachedHash;
private transient SecretKey encryptionKey;
```

### –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è

–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

```java
private void writeObject(ObjectOutputStream out) throws IOException {
    out.defaultWriteObject(); // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
    out.writeInt(encryptedAge);
}

private void readObject(ObjectInputStream in) 
        throws IOException, ClassNotFoundException {
    in.defaultReadObject(); // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ transient –ø–æ–ª–µ–π
    this.cachedHash = computeHash();
}
```

### Externalizable

–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –±–µ–∑ "–º–∞–≥–∏–∏":

```java
public class Person implements Externalizable {
    
    @Override
    public void writeExternal(ObjectOutput out) throws IOException {
        out.writeUTF(name);
        out.writeInt(age);
    }
    
    @Override
    public void readExternal(ObjectInput in) 
            throws IOException, ClassNotFoundException {
        this.name = in.readUTF();
        this.age = in.readInt();
    }
    
    // –í–ê–ñ–ù–û: –Ω—É–∂–µ–Ω public –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤!
    public Person() {}
}
```

### –ó–∞—â–∏—Ç–∞ Singleton –æ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

```java
public class Singleton implements Serializable {
    private static final Singleton INSTANCE = new Singleton();
    
    private Object readResolve() throws ObjectStreamException {
        return INSTANCE; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä
    }
}
```

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ –Ω–µ–Ω–∞–¥—ë–∂–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ ‚Äî **—Å–µ—Ä—å—ë–∑–Ω–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å**!

1. **Gadget chains** ‚Äî —Ü–µ–ø–æ—á–∫–∏ –≤—ã–∑–æ–≤–æ–≤, –ø—Ä–∏–≤–æ–¥—è—â–∏–µ –∫ RCE
2. **–û–±—Ö–æ–¥ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞** ‚Äî –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. **DoS** ‚Äî –æ–≥—Ä–æ–º–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Å—ä–µ–¥–∞—é—Ç –ø–∞–º—è—Ç—å

**–ó–∞—â–∏—Ç–∞ (Java 9+)**:
```java
ObjectInputFilter filter = ObjectInputFilter.Config.createFilter(
    "java.base/*;!*" // –¢–æ–ª—å–∫–æ –∫–ª–∞—Å—Å—ã –∏–∑ java.base
);
ois.setObjectInputFilter(filter);
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã Java —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

| –§–æ—Ä–º–∞—Ç | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã |
|--------|-------|--------|
| JSON (Jackson, Gson) | –ß–∏—Ç–∞–µ–º—ã–π, –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π | –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞, –º–µ–¥–ª–µ–Ω–Ω–µ–µ |
| Protocol Buffers | –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π, –±—ã—Å—Ç—Ä—ã–π, —Å—Ö–µ–º–∞ | –ù—É–∂–Ω–∞ –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è |
| Kryo | –ë—ã—Å—Ç—Ä—ã–π, –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π | Java-only |
| Avro | –°—Ö–µ–º–∞, —ç–≤–æ–ª—é—Ü–∏—è | –°–ª–æ–∂–Ω–µ–µ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ |

## üéØ –ó–∞–¥–∞–Ω–∏–µ

### –ó–∞–¥–∞—á–∞ 1: –ë–∞–∑–æ–≤–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è

–†–µ–∞–ª–∏–∑—É–π `SerializationUtils`:
- `serialize(obj)` ‚Äî –æ–±—ä–µ–∫—Ç –≤ –±–∞–π—Ç—ã
- `deserialize(bytes)` ‚Äî –±–∞–π—Ç—ã –≤ –æ–±—ä–µ–∫—Ç
- `deepCopy(obj)` ‚Äî –≥–ª—É–±–æ–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é

### –ó–∞–¥–∞—á–∞ 2: –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è

–†–µ–∞–ª–∏–∑—É–π `SerializableEntity`:
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `transient` –ø–æ–ª–µ–π
- –ú–µ—Ç–æ–¥—ã `writeObject` –∏ `readObject`
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –ó–∞–¥–∞—á–∞ 3: –ó–∞—â–∏—Ç–∞ Singleton

–†–µ–∞–ª–∏–∑—É–π `SerializableSingleton`:
- –ì–∞—Ä–∞–Ω—Ç–∏—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
- –ú–µ—Ç–æ–¥ `readResolve`

### –ó–∞–¥–∞—á–∞ 4: –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ –∫–ª–∞—Å—Å –∏ –æ–±–µ—Å–ø–µ—á—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã —á–∏—Ç–∞—Ç—å—Å—è
- –ù–æ–≤–æ–µ –ø–æ–ª–µ –ø–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## ü§î –ú–µ—Ç–∞-–≤–æ–ø—Ä–æ—Å—ã

1. –ü–æ—á–µ–º—É Java-—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–π?
2. –ö–æ–≥–¥–∞ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Externalizable` –≤–º–µ—Å—Ç–æ `Serializable`?
3. –ö–∞–∫ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?
4. –ü–æ—á–µ–º—É `transient` –ø–æ–ª—è –≤–∞–∂–Ω—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏?

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ü–æ–Ω–∏–º–∞–µ—à—å —Ä–∞–∑–Ω–∏—Ü—É `Serializable` vs `Externalizable`
- [ ] –ó–Ω–∞–µ—à—å —Ä–æ–ª—å `serialVersionUID`
- [ ] –£–º–µ–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `transient`
- [ ] –ú–æ–∂–µ—à—å –∑–∞—â–∏—Ç–∏—Ç—å Singleton –æ—Ç "–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
- [ ] –ó–Ω–∞–µ—à—å –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- [ ] –ü–æ–Ω–∏–º–∞–µ—à—å, –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (JSON, Protobuf)
