# ะะพะดัะปั 15: Java Memory Model

> **ะฃัะพะฒะตะฝั**: โญโญโญโญโญ ะญะบัะฟะตัั  
> **ะัะตะผั**: 6-8 ัะฐัะพะฒ

## ๐ ะขะตะพัะตัะธัะตัะบะพะต ะฒะฒะตะดะตะฝะธะต

### ะะฐัะตะผ ะฝัะถะฝะฐ JMM?

ะกะพะฒัะตะผะตะฝะฝัะต CPU ะธัะฟะพะปัะทััั:
- **ะััะธ L1/L2/L3** โ ะบะฐะถะดะพะต ัะดัะพ ะธะผะตะตั ัะฒะพะน ะบัั
- **Store buffers** โ ะฑััะตัะธะทะฐัะธั ะทะฐะฟะธัะตะน
- **Instruction reordering** โ ะฟะตัะตัะฟะพััะดะพัะธะฒะฐะฝะธะต ะธะฝััััะบัะธะน ะดะปั ะพะฟัะธะผะธะทะฐัะธะธ

ะะตะท JMM ะฟัะพะณัะฐะผะผะธัั ะฝะต ะผะพะถะตั ะฟะพะปะฐะณะฐัััั ะฝะฐ ะฟะพััะดะพะบ ะพะฟะตัะฐัะธะน ะผะตะถะดั ะฟะพัะพะบะฐะผะธ!

### Happens-Before: ะะพะปะฝัะน ัะฟะธัะพะบ

ะัะฝะพัะตะฝะธะต **happens-before** ะณะฐัะฐะฝัะธััะตั ะฒะธะดะธะผะพััั ะธะทะผะตะฝะตะฝะธะน ะผะตะถะดั ะฟะพัะพะบะฐะผะธ:

1. **Program order**: ะบะฐะถะดะพะต ะดะตะนััะฒะธะต ะฒ ะฟะพัะพะบะต HB ะฟะพัะปะตะดัััะตะณะพ ะดะตะนััะฒะธั ะฒ ัะพะผ ะถะต ะฟะพัะพะบะต
2. **Monitor lock**: `unlock()` HB ะฟะพัะปะตะดัััะตะณะพ `lock()` ัะพะณะพ ะถะต ะผะพะฝะธัะพัะฐ
3. **Volatile write/read**: ะทะฐะฟะธัั ะฒ volatile HB ะฟะพัะปะตะดัััะตะณะพ ััะตะฝะธั ัะพะน ะถะต ะฟะตัะตะผะตะฝะฝะพะน
4. **Thread start**: `thread.start()` HB ะฟะตัะฒะพะณะพ ะดะตะนััะฒะธั ะฒ ะทะฐะฟััะตะฝะฝะพะผ ะฟะพัะพะบะต
5. **Thread termination**: ะฟะพัะปะตะดะฝะตะต ะดะตะนััะฒะธะต ะฒ ะฟะพัะพะบะต HB ะพะฑะฝะฐััะถะตะฝะธั ะทะฐะฒะตััะตะฝะธั (`join()`, `isAlive()` == false)
6. **Thread interrupt**: ะฒัะทะพะฒ `interrupt()` HB ะพะฑะฝะฐััะถะตะฝะธั ะฟัะตััะฒะฐะฝะธั
7. **Finalizer**: ะบะพะฝะตั ะบะพะฝััััะบัะพัะฐ HB ะฝะฐัะฐะปะฐ `finalize()`
8. **ะขัะฐะฝะทะธัะธะฒะฝะพััั**: ะตัะปะธ A HB B ะธ B HB C, ัะพ A HB C

### Visibility vs Atomicity vs Ordering

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     JMM Guarantees                          โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ   Keyword   โ   Visibility    โ  Atomicity   โ  Ordering   โ
โโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโค
โ  volatile   โ      โ         โ   โ (r/w)   โ     โ      โ
โ synchronizedโ      โ         โ      โ      โ     โ      โ
โ    final    โ      โ*        โ      โ      โ     โ*     โ
โ  AtomicXxx  โ      โ         โ      โ      โ     โ      โ
โโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโ
* ะดะปั ะฟัะฐะฒะธะปัะฝะพ ะพะฟัะฑะปะธะบะพะฒะฐะฝะฝัั ะพะฑัะตะบัะพะฒ
```

### Data Race vs Race Condition

- **Data race** (ะพัะธะฑะบะฐ ัะธะฝััะพะฝะธะทะฐัะธะธ): 
  - ะะฒะฐ ะฟะพัะพะบะฐ ะพะฑัะฐัะฐัััั ะบ ะพะดะฝะพะน ะฟะตัะตะผะตะฝะฝะพะน
  - ะฅะพัั ะฑั ะพะดะธะฝ ะฟะธัะตั
  - ะะตั happens-before ะผะตะถะดั ะดะพัััะฟะฐะผะธ
  - **ะญัะพ UB (undefined behavior)!**

- **Race condition** (ะปะพะณะธัะตัะบะฐั ะพัะธะฑะบะฐ):
  - ะะตะทัะปััะฐั ะทะฐะฒะธัะธั ะพั ะฟะพััะดะบะฐ ะฒัะฟะพะปะฝะตะฝะธั
  - ะะพะถะตั ะฑััั ะดะฐะถะต ะฟัะธ ะพััััััะฒะธะธ data race

### Safe Publication

ะะฑัะตะบั ััะธัะฐะตััั **safely published**, ะตัะปะธ:
1. ะกััะปะบะฐ ะธ ัะพััะพัะฝะธะต ะพะฑัะตะบัะฐ ะฒะธะดะฝั ะดััะณะธะผ ะฟะพัะพะบะฐะผ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ
2. ะะตั ัะธัะบะฐ ัะฒะธะดะตัั "ัะฐััะธัะฝะพ ัะบะพะฝััััะธัะพะฒะฐะฝะฝัะน" ะพะฑัะตะบั

**ะกะฟะพัะพะฑั safe publication**:
```java
// 1. ะงะตัะตะท volatile
private volatile Holder holder;

// 2. ะงะตัะตะท synchronized
synchronized (lock) { this.holder = new Holder(); }

// 3. ะงะตัะตะท final ะฟะพะปะต (if properly constructed)
public class SafeHolder {
    private final Holder holder = new Holder();
}

// 4. ะงะตัะตะท static initializer (ะณะฐัะฐะฝัะธััะตััั JVM)
private static final Holder holder = new Holder();

// 5. ะงะตัะตะท AtomicReference
private final AtomicReference<Holder> ref = new AtomicReference<>();
```

### ะะพัะตะผั DCL ัะปะพะผะฐะฝ ะฑะตะท volatile?

```java
// BROKEN!
if (instance == null) {                    // (1)
    synchronized (lock) {
        if (instance == null) {
            instance = new Singleton();    // (2)
        }
    }
}
return instance;                           // (3)
```

ะัะพะฑะปะตะผะฐ: `instance = new Singleton()` โ ััะพ ััะธ ะพะฟะตัะฐัะธะธ:
1. `memory = allocate()`
2. `Singleton(memory)` โ ะฒัะทะพะฒ ะบะพะฝััััะบัะพัะฐ
3. `instance = memory`

ะะพะผะฟะธะปััะพั/CPU ะผะพะถะตั ะฟะตัะตัะฟะพััะดะพัะธัั (2) ะธ (3)!
ะััะณะพะน ะฟะพัะพะบ ะผะพะถะตั ัะฒะธะดะตัั ะฝะตะฝัะปะตะฒะพะน `instance` ั ะฝะตะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฝัะผะธ ะฟะพะปัะผะธ.

**Fix**: `private static volatile Singleton instance;`

## ๐ฏ ะะฐะดะฐะฝะธะต

### ะะฐะดะฐัะฐ 1: ะะตะผะพะฝัััะฐัะธั ะฟัะพะฑะปะตะผั ะฒะธะดะธะผะพััะธ

ะะฐะฟะธัะธ ะบะพะด, ะณะดะต ะพะดะธะฝ ะฟะพัะพะบ ัััะฐะฝะฐะฒะปะธะฒะฐะตั `flag = true`, ะฐ ะดััะณะพะน ะฑะตัะบะพะฝะตัะฝะพ ะบัััะธััั ะฒ ัะธะบะปะต `while (!flag)`. ะะตะท volatile ัะธะบะป ะผะพะถะตั ะฝะธะบะพะณะดะฐ ะฝะต ะทะฐะฒะตััะธัััั!

### ะะฐะดะฐัะฐ 2: Broken DCL โ Fixed DCL

1. ะะตะฐะปะธะทัะน singleton ั DCL ะฑะตะท volatile
2. ะะฑัััะฝะธ, ะฟะพัะตะผั ััะพ ะพะฟะฐัะฝะพ (ะบะฐะบะพะน ััะตะฝะฐัะธะน ะฟัะธะฒะตะดัั ะบ ะฑะฐะณั?)
3. ะัะฟัะฐะฒั ั volatile

### ะะฐะดะฐัะฐ 3: Safe Publication Patterns

ะะตะฐะปะธะทัะน ััะธ ัะฟะพัะพะฑะฐ ะฑะตะทะพะฟะฐัะฝะพะน ะฟัะฑะปะธะบะฐัะธะธ ะพะฑัะตะบัะฐ:
1. ะงะตัะตะท volatile
2. ะงะตัะตะท synchronized
3. ะงะตัะตะท final + immutable

### ะะฐะดะฐัะฐ 4: AtomicInteger ะฟะพะด ะบะฐะฟะพัะพะผ

ะะฑัััะฝะธ, ะบะฐะบ `AtomicInteger.incrementAndGet()` ะดะพััะธะณะฐะตั ะฐัะพะผะฐัะฝะพััะธ ะฑะตะท synchronized.

## โ ะงะตะบ-ะปะธัั

- [ ] ะะพะณั ะพะฑัััะฝะธัั ะฒัะต 8 ะฟัะฐะฒะธะป happens-before
- [ ] ะะพะฝะธะผะฐั ัะฐะทะฝะธัั ะผะตะถะดั visibility, atomicity ะธ ordering
- [ ] ะะฝะฐั, ะฟะพัะตะผั volatile ะฝะตะดะพััะฐัะพัะฝะพ ะดะปั i++
- [ ] ะะพะณั ะพะฑัััะฝะธัั, ะฟะพัะตะผั DCL ัะปะพะผะฐะฝ ะฑะตะท volatile
- [ ] ะะพะฝะธะผะฐั safe publication patterns
- [ ] ะะฝะฐั, ััะพ ัะฐะบะพะต memory barrier (ะฒ ะพะฑัะธั ัะตััะฐั)

## ๐ฌ ะะตัะฐ-ะฒะพะฟัะพัั

1. ะะพัะตะผั final ะฟะพะปั "ะฑะตะทะพะฟะฐัะฝั" ะฟะพัะปะต ะบะพะฝััััะบัะพัะฐ?
2. ะงัะพ ะฑัะดะตั, ะตัะปะธ ะบะพะฝััััะบัะพั "ััะตััั" this ะดะพ ะทะฐะฒะตััะตะฝะธั?
3. ะะฐะบ ัะฐะฑะพัะฐะตั volatile ะฟะพะด ะบะฐะฟะพัะพะผ (memory barriers)?
4. ะะพัะตะผั synchronized ะดะพัะพะถะต volatile?

